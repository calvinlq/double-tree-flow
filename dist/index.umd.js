(function(v,y){typeof exports=="object"&&typeof module<"u"?module.exports=y():typeof define=="function"&&define.amd?define(y):(v=typeof globalThis<"u"?globalThis:v||self,v.DoubleTreeFlow=y())})(this,(function(){"use strict";const v="data:image/svg+xml,%3csvg%20width='101'%20height='101'%20viewBox='0%200%20101%20101'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20d='M10.5208%2024.6667V16.8333C10.5208%2014.5091%2012.4049%2012.625%2014.7291%2012.625H39.9791L50.5%2025.25H86.2708C88.5951%2025.25%2090.4791%2027.1341%2090.4791%2029.4583V84.1667C90.4791%2086.4909%2088.5951%2088.375%2086.2708%2088.375H14.7291C12.4049%2088.375%2010.5208%2086.4909%2010.5208%2084.1667V78.5'%20stroke='%23818181'%20stroke-width='5'%20stroke-linecap='round'%20stroke-linejoin='round'/%3e%3cpath%20d='M3%2062.5V47.5H25.5V32.4142C25.5%2031.5233%2026.5771%2031.0771%2027.2071%2031.7071L50.2929%2054.7929C50.6834%2055.1834%2050.6834%2055.8166%2050.2929%2056.2071L27.2071%2079.2929C26.5771%2079.9229%2025.5%2079.4767%2025.5%2078.5858V62.5H3Z'%20fill='%23F1BA10'%20stroke='%233D3D3D'%20stroke-width='2'/%3e%3c/svg%3e",y="data:image/svg+xml,%3csvg%20width='101'%20height='101'%20viewBox='0%200%20101%20101'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20d='M90.4791%2032V29.4583C90.4791%2027.1341%2088.5951%2025.25%2086.2708%2025.25H50.5L39.9791%2012.625H14.7291C12.4049%2012.625%2010.5208%2014.5091%2010.5208%2016.8333V84.1667C10.5208%2086.4909%2012.4049%2088.375%2014.7291%2088.375H86.2708C88.5951%2088.375%2090.4791%2086.4909%2090.4791%2084.1667V79.5'%20stroke='%23818181'%20stroke-width='5'%20stroke-linecap='round'%20stroke-linejoin='round'/%3e%3cpath%20d='M51%2062.5V47.5H73.5V32.4142C73.5%2031.5233%2074.5771%2031.0771%2075.2071%2031.7071L98.2929%2054.7929C98.6834%2055.1834%2098.6834%2055.8166%2098.2929%2056.2071L75.2071%2079.2929C74.5771%2079.9229%2073.5%2079.4767%2073.5%2078.5858V62.5H51Z'%20fill='%230068D4'%20stroke='%233D3D3D'%20stroke-width='2'/%3e%3c/svg%3e",S="data:image/svg+xml,%3c?xml%20version='1.0'%20encoding='utf-8'?%3e%3c!--%20Generator:%20Adobe%20Illustrator%2022.0.0,%20SVG%20Export%20Plug-In%20.%20SVG%20Version:%206.00%20Build%200)%20--%3e%3csvg%20version='1.1'%20id='图层_1'%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20x='0px'%20y='0px'%20viewBox='0%200%2054%2054'%20style='enable-background:new%200%200%2054%2054;'%20xml:space='preserve'%20width='100px'%20height='100px'%3e%3cstyle%20type='text/css'%3e%20.st0{fill:none;stroke:%23333333;stroke-miterlimit:10;}%20.st1{fill:%23F1BA10;stroke:%23333333;stroke-miterlimit:10;}%20.st2{fill:%231664B5;stroke:%23333333;stroke-miterlimit:10;}%20%3c/style%3e%3cg%3e%3cpolygon%20class='st0'%20points='47.4,46.6%206.1,46.6%206.6,7.4%2047.9,7.4%20'/%3e%3cg%3e%3cpolygon%20class='st1'%20points='26.4,27.8%2013.8,15.2%2013.8,24.3%202.5,24.3%202.5,31.3%2013.8,31.3%2013.8,40.4%20'/%3e%3cpolygon%20class='st2'%20points='51.5,27.8%2038.9,15.2%2038.9,24.3%2027.6,24.3%2027.6,31.3%2038.9,31.3%2038.9,40.4%20'/%3e%3c/g%3e%3c/g%3e%3c/svg%3e";class V{constructor(t,s,i,r,e={}){this.connections=[],this.selectedNode=null,this.enableLink=e.enableLink!==void 0?e.enableLink:!1,this.enableTxtBgColor=e.enableTxtBgColor!==void 0?e.enableTxtBgColor:!1,this.bezier=e.bezier!==void 0?e.bezier:100,this.leftTreeData=s,this.rightTreeData=i,this.linkList=r;const n=document.getElementById(t);if(!n)throw new Error(`Container with id "${t}" not found`);n.style.display="flex",n.style.justifyContent="space-around",n.style.padding="6px 10px",this.container=n,this.init()}init(){this.container.innerHTML='<svg id="connection-layer"></svg>';const t=document.createElement("div");t.className="tree-container",t.id="leftTree";const s=this.container.dataset.treewidth,i=this.container.dataset.treeheight;s&&(t.style.width=`${s}px`),i&&(t.style.maxHeight=`${i}px`);const r=document.createElement("div");r.className="tree-container",r.id="rightTree",s&&(r.style.width=`${s}px`),i&&(r.style.maxHeight=`${i}px`),this.container.appendChild(t),this.container.appendChild(r),this.initializeTrees(),window.addEventListener("resize",()=>this.drawConnections())}getParentNode(t){const s=document.querySelector(`[data-id="${t}"]`),i=s.getBoundingClientRect();return i.top!==0?i:this.getParentNode(s.parentElement.parentElement.dataset.id)}renderTreeNode(t,s){const i=document.createElement("div");let r=`tree-node level-${t.level}`;t.children&&t.children.length>0&&(r+=" has-children"),t.level===1&&(r+=" level-1-node"),i.className=r,i.dataset.id=t.id,i.dataset.level=t.level.toString(),t.parentId&&(i.dataset.parentId=t.parentId);const e=document.createElement("div");if(e.className=`tree-node-row level-${t.level}`,i.appendChild(e),t.children&&t.children.length>0){const o=document.createElement("span");o.className="tree-toggle minus",o.addEventListener("click",w=>{w.stopPropagation();const l=i.querySelector(".tree-children");l.classList.toggle("active"),l.classList.contains("active")?(o.classList.remove("plus"),o.classList.add("minus")):(o.classList.remove("minus"),o.classList.add("plus")),this.drawConnections()}),e.appendChild(o)}else{const o=document.createElement("span");o.className="no-toggle",o.style.width="3px",o.style.display="inline-block",o.style.marginRight="5px",e.classList.add("not-children"),e.appendChild(o)}let n="";switch(t.type){case"input":n=v;break;case"output":n=y;break;case"inOut":n=S;break;default:n=t.icon||""}if(n){const o=document.createElement("img");o.src=n,o.className="tree-icon",e.appendChild(o)}const a=document.createElement("span");if(a.className="tree-label",this.enableTxtBgColor?(a.className+=" tree-bg-color",a.style.padding="2px 10px"):a.className+=" default",a.textContent=t.label,a.addEventListener("click",()=>{this.handleNodeClick(t.id)}),e.appendChild(a),t.children&&t.children.length>0){const o=document.createElement("div");o.className="tree-children active",i.appendChild(o),t.children.forEach(w=>{w.parentId=t.id,this.renderTreeNode(w,o)})}s.appendChild(i)}handleNodeClick(t){if(this.selectedNode){const i=document.querySelector(`[data-id="${this.selectedNode}"] .tree-label`);i&&i.classList.remove("selected")}if(this.selectedNode&&this.selectedNode!==t){const i=this.selectedNode.startsWith("left-")&&t.startsWith("right-"),r=this.selectedNode.startsWith("right-")&&t.startsWith("left-");if(this.enableLink&&(i||r)){const e=this.selectedNode,n=t;this.connections.push({source:e,target:n}),this.drawConnections(),this.selectedNode=null;return}else if(!this.enableLink){this.selectedNode=t;const e=document.querySelector(`[data-id="${t}"] .tree-label`);e&&e.classList.add("selected");return}}if(this.selectedNode===t){const i=document.querySelector(`[data-id="${t}"] .tree-label`);i&&i.classList.remove("selected"),this.selectedNode=null;return}this.selectedNode=t;const s=document.querySelector(`[data-id="${t}"] .tree-label`);s&&s.classList.add("selected")}isNodeVisible(t){const s=document.querySelector(`[data-id="${t}"]`);if(!s)return!1;let i=s.parentElement;for(;i&&i.classList.contains("tree-children");){if(!i.classList.contains("active"))return!1;i=i.parentElement?.parentElement||null}const r=s.closest(".tree-container");if(!r)return!1;const e=s.getBoundingClientRect(),n=r.getBoundingClientRect();return e.bottom>n.top&&e.top<n.bottom}findNearestVisibleAncestor(t){const s=document.querySelector(`[data-id="${t}"]`);if(!s)return null;if(this.isNodeVisible(t))return t;let i=s.dataset.parentId;for(;i;){if(this.isNodeVisible(i))return i;const l=document.querySelector(`[data-id="${i}"]`);if(!l)break;i=l.dataset.parentId}const r=s.dataset.level,e=Array.from(document.querySelectorAll(`.tree-node[data-level="${r}"]`)),n=s.getBoundingClientRect(),a=e.filter(l=>this.isNodeVisible(l.dataset.id));if(a.length===0){const l=s.parentElement?.closest(".tree-node");return l?this.findNearestVisibleAncestor(l.dataset.id):null}return a.sort((l,p)=>{const $=l.getBoundingClientRect(),L=p.getBoundingClientRect();return Math.abs($.top-n.top)-Math.abs(L.top-n.top)}),a[0].dataset.id}addScrollListenersWithThrottle(){document.querySelectorAll(".tree-container").forEach(s=>{s.addEventListener("scroll",this.throttle(()=>this.drawConnections(),10))})}throttle(t,s){let i=0;return()=>{const r=Date.now();r-i>=s&&(i=r,t())}}getNodeVisibilityPosition(t){const s=document.querySelector(`[data-id="${t}"]`)?.querySelector(".tree-label");if(!s)return"unknown";const i=s.closest(".tree-container");if(!i)return"unknown";const r=s.getBoundingClientRect(),e=i.getBoundingClientRect();let n=null;return r.top===0&&(n=this.getParentNode(t)),r.top===0&&n?n.top<e.top?"top":n.bottom>e.bottom?"bottom":"visible":r.top<e.top?"top":r.bottom>e.bottom?"bottom":"visible"}findFirstVisibleNode(){const t=document.querySelectorAll(".tree-node");for(const s of Array.from(t)){const i=s.dataset.id;if(this.isNodeVisible(i))return s}return null}drawConnections(){const t=document.getElementById("connection-layer");if(t&&(t.innerHTML="",t.getBoundingClientRect(),this.connections.forEach(s=>{const i=document.querySelector(`[data-id="${s.source}"] .tree-label`),r=document.querySelector(`[data-id="${s.target}"] .tree-label`);if(i&&r){const e=t.getBoundingClientRect(),n=i.closest(".tree-container");if(!n)return;const a=r.closest(".tree-container");if(!a)return;const o=i.getBoundingClientRect(),w=r.getBoundingClientRect(),l=n.getBoundingClientRect(),p=a.getBoundingClientRect(),$=s.source.startsWith("left-")&&s.target.startsWith("right-"),L=s.source.startsWith("right-")&&s.target.startsWith("left-"),R=this.getNodeVisibilityPosition(s.source),k=this.getNodeVisibilityPosition(s.target);let f,u,b,h;if(this.isNodeVisible(s.source)){const N=n.getBoundingClientRect();f=n.id==="leftTree"?N.right+5-e.left:N.left-5-e.left,u=o.top+o.height/2-e.top}else{const N=document.querySelector(`[data-id="${s.source}"]`);let c=null,m=N.parentElement;for(;m&&m.classList.contains("tree-children");){if(!m.classList.contains("active")){const C=m.parentElement.dataset.id;if(this.isNodeVisible(C)){c=C;break}}m=m.parentElement?.parentElement||null}if(c){const C=document.querySelector(`[data-id="${c}"] .tree-label`).getBoundingClientRect();f=n.id==="leftTree"?l.right+5-e.left:l.left-5-e.left,u=C.top+C.height/2-e.top}else if(f=n.id==="leftTree"?l.right+5-e.left:l.left-5-e.left,R==="top")u=l.top-e.top;else if(R==="bottom")u=l.bottom-e.top;else{const d=this.findNearestVisibleAncestor(s.source);if(d){const C=document.querySelector(`[data-id="${d}"] .tree-label`).getBoundingClientRect();u=C.top+C.height/2-e.top}else u=l.top+l.height/2-e.top}}f-=e.left,u-=e.top;let A=null;if(!this.isNodeVisible(s.source)){let c=document.querySelector(`[data-id="${s.source}"]`).parentElement;for(;c&&c.classList.contains("tree-children");){if(!c.classList.contains("active")){const d=c.parentElement.dataset.id;if(this.isNodeVisible(d)){A=d;break}}c=c.parentElement?.parentElement||null}}R==="top"&&!A&&(u=n.getBoundingClientRect().top-e.top);let T=null;if(this.isNodeVisible(s.target))b=a.id==="leftTree"?p.right+5-e.left:p.left-5-e.left,h=w.top+w.height/2-e.top;else{let c=document.querySelector(`[data-id="${s.target}"]`).parentElement;for(;c&&c.classList.contains("tree-children");){if(!c.classList.contains("active")){const d=c.parentElement.dataset.id;if(this.isNodeVisible(d)){T=d;break}}c=c.parentElement?.parentElement||null}if(T){const d=document.querySelector(`[data-id="${T}"] .tree-label`).getBoundingClientRect();b=a.id==="leftTree"?p.right+5-e.left:p.left-5-e.left,h=d.top+d.height/2-e.top}else if(b=a.id==="leftTree"?p.right+5-e.left:p.left-5-e.left,k==="top")h=p.top-e.top-10;else if(k==="bottom")h=p.bottom-10-e.top;else{const m=this.findNearestVisibleAncestor(s.target);if(m){const d=document.querySelector(`[data-id="${m}"] .tree-label`).getBoundingClientRect();h=d.top+d.height/2-e.top}else h=p.top+p.height/2-e.top}}b-=e.left,h-=e.top,k==="top"&&!T?h=a.getBoundingClientRect().top-e.top:k==="bottom"&&!T&&(h=a.getBoundingClientRect().bottom-e.top);const g=document.createElementNS("http://www.w3.org/2000/svg","path");let x;const E=this.bezier||100;$?(x=`M ${f} ${u} C ${f+E} ${u}, ${b-E} ${h}, ${b} ${h}`,g.setAttribute("marker-end","url(#arrowhead-end)")):L?(x=`M ${f} ${u} C ${f-E} ${u}, ${b+E} ${h}, ${b} ${h}`,g.setAttribute("marker-end","url(#arrowhead-start)")):x=`M ${f} ${u} C ${f+E} ${u}, ${b-E} ${h}, ${b} ${h}`,g.setAttribute("d",x),$?g.setAttribute("stroke","#0090F0"):L?g.setAttribute("stroke","#FE732F"):g.setAttribute("stroke","#666");const B=this.isNodeVisible(s.source),q=this.isNodeVisible(s.target),D=R==="top",H=k==="top";g.setAttribute("stroke-width","1.5"),g.setAttribute("fill","none"),D||H||!B||!q?g.setAttribute("stroke-dasharray","5,5"):g.removeAttribute("stroke-dasharray"),t.appendChild(g)}}),this.connections.length>0&&!document.getElementById("arrowhead-end"))){const s=document.createElementNS("http://www.w3.org/2000/svg","defs"),i=document.createElementNS("http://www.w3.org/2000/svg","marker");i.setAttribute("id","arrowhead-end"),i.setAttribute("markerWidth","10"),i.setAttribute("markerHeight","7"),i.setAttribute("refX","9"),i.setAttribute("refY","3.5"),i.setAttribute("orient","auto");const r=document.createElementNS("http://www.w3.org/2000/svg","polygon");r.setAttribute("points","0 0, 10 3.5, 0 7"),r.setAttribute("fill","#4096ff"),i.appendChild(r);const e=document.createElementNS("http://www.w3.org/2000/svg","marker");e.setAttribute("id","arrowhead-start"),e.setAttribute("markerWidth","10"),e.setAttribute("markerHeight","7"),e.setAttribute("refX","9"),e.setAttribute("refY","3.5"),e.setAttribute("orient","auto");const n=document.createElementNS("http://www.w3.org/2000/svg","polygon");n.setAttribute("points","0 0, 10 3.5, 0 7"),n.setAttribute("fill","#ff7a45"),e.appendChild(n),s.appendChild(i),s.appendChild(e),t.appendChild(s)}}initializeTrees(){const t=document.getElementById("leftTree"),s=document.getElementById("rightTree");!t||!s||(this.leftTreeData.forEach(i=>{this.renderTreeNode(i,t)}),this.rightTreeData.forEach(i=>{this.renderTreeNode(i,s)}),this.addScrollListenersWithThrottle(),this.connections.push(...this.linkList),this.drawConnections())}redraw(){this.drawConnections()}updateData(t,s,i){this.leftTreeData=t,this.rightTreeData=s,this.linkList=i,this.connections=[...i],this.initializeTrees()}}return V}));
