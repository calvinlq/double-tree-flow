(function(w,$){typeof exports=="object"&&typeof module<"u"?module.exports=$():typeof define=="function"&&define.amd?define($):(w=typeof globalThis<"u"?globalThis:w||self,w.DoubleTreeFlow=$())})(this,(function(){"use strict";class w{constructor(t,n,i,r,e={}){this.connections=[],this.selectedNode=null,this.enableLink=e.enableLink!==void 0?e.enableLink:!1,this.enableTxtBgColor=e.enableTxtBgColor!==void 0?e.enableTxtBgColor:!1,this.bezier=e.bezier!==void 0?e.bezier:100,this.leftTreeData=n,this.rightTreeData=i,this.linkList=r;const s=document.getElementById(t);if(!s)throw new Error(`Container with id "${t}" not found`);s.style.display="flex",s.style.justifyContent="space-around",s.style.padding="6px 10px",this.container=s,this.init()}init(){this.container.innerHTML='<svg id="connection-layer"></svg>';const t=document.createElement("div");t.className="tree-container",t.id="leftTree";const n=this.container.dataset.treewidth,i=this.container.dataset.treeheight;n&&(t.style.width=`${n}px`),i&&(t.style.maxHeight=`${i}px`);const r=document.createElement("div");r.className="tree-container",r.id="rightTree",n&&(r.style.width=`${n}px`),i&&(r.style.maxHeight=`${i}px`),this.container.appendChild(t),this.container.appendChild(r),this.initializeTrees(),window.addEventListener("resize",()=>this.drawConnections())}getParentNode(t){const n=document.querySelector(`[data-id="${t}"]`),i=n.getBoundingClientRect();return i.top!==0?i:this.getParentNode(n.parentElement.parentElement.dataset.id)}renderTreeNode(t,n){const i=document.createElement("div");let r=`tree-node level-${t.level}`;t.children&&t.children.length>0&&(r+=" has-children"),t.level===1&&(r+=" level-1-node"),i.className=r,i.dataset.id=t.id,i.dataset.level=t.level.toString(),t.parentId&&(i.dataset.parentId=t.parentId);const e=document.createElement("div");if(e.className=`tree-node-row level-${t.level}`,i.appendChild(e),t.children&&t.children.length>0){const o=document.createElement("span");o.className="tree-toggle minus",o.addEventListener("click",E=>{E.stopPropagation();const l=i.querySelector(".tree-children");l.classList.toggle("active"),l.classList.contains("active")?(o.classList.remove("plus"),o.classList.add("minus")):(o.classList.remove("minus"),o.classList.add("plus")),this.drawConnections()}),e.appendChild(o)}else{const o=document.createElement("span");o.className="no-toggle",o.style.width="3px",o.style.display="inline-block",o.style.marginRight="5px",e.classList.add("not-children"),e.appendChild(o)}let s="";switch(t.type){case"input":s="assets/images/input.svg";break;case"output":s="assets/images/output.svg";break;case"inOut":s="assets/images/inOut.svg";break;default:s=t.icon||""}if(s){const o=document.createElement("img");o.src=s,o.className="tree-icon",e.appendChild(o)}const a=document.createElement("span");if(a.className="tree-label",this.enableTxtBgColor?(a.className+=" tree-bg-color",a.style.padding="2px 10px"):a.className+=" default",a.textContent=t.label,a.addEventListener("click",()=>{this.handleNodeClick(t.id)}),e.appendChild(a),t.children&&t.children.length>0){const o=document.createElement("div");o.className="tree-children active",i.appendChild(o),t.children.forEach(E=>{E.parentId=t.id,this.renderTreeNode(E,o)})}n.appendChild(i)}handleNodeClick(t){if(this.selectedNode){const i=document.querySelector(`[data-id="${this.selectedNode}"] .tree-label`);i&&i.classList.remove("selected")}if(this.selectedNode&&this.selectedNode!==t){const i=this.selectedNode.startsWith("left-")&&t.startsWith("right-"),r=this.selectedNode.startsWith("right-")&&t.startsWith("left-");if(this.enableLink&&(i||r)){const e=this.selectedNode,s=t;this.connections.push({source:e,target:s}),this.drawConnections(),this.selectedNode=null;return}else if(!this.enableLink){this.selectedNode=t;const e=document.querySelector(`[data-id="${t}"] .tree-label`);e&&e.classList.add("selected");return}}if(this.selectedNode===t){const i=document.querySelector(`[data-id="${t}"] .tree-label`);i&&i.classList.remove("selected"),this.selectedNode=null;return}this.selectedNode=t;const n=document.querySelector(`[data-id="${t}"] .tree-label`);n&&n.classList.add("selected")}isNodeVisible(t){const n=document.querySelector(`[data-id="${t}"]`);if(!n)return!1;let i=n.parentElement;for(;i&&i.classList.contains("tree-children");){if(!i.classList.contains("active"))return!1;i=i.parentElement?.parentElement||null}const r=n.closest(".tree-container");if(!r)return!1;const e=n.getBoundingClientRect(),s=r.getBoundingClientRect();return e.bottom>s.top&&e.top<s.bottom}findNearestVisibleAncestor(t){const n=document.querySelector(`[data-id="${t}"]`);if(!n)return null;if(this.isNodeVisible(t))return t;let i=n.dataset.parentId;for(;i;){if(this.isNodeVisible(i))return i;const l=document.querySelector(`[data-id="${i}"]`);if(!l)break;i=l.dataset.parentId}const r=n.dataset.level,e=Array.from(document.querySelectorAll(`.tree-node[data-level="${r}"]`)),s=n.getBoundingClientRect(),a=e.filter(l=>this.isNodeVisible(l.dataset.id));if(a.length===0){const l=n.parentElement?.closest(".tree-node");return l?this.findNearestVisibleAncestor(l.dataset.id):null}return a.sort((l,p)=>{const R=l.getBoundingClientRect(),S=p.getBoundingClientRect();return Math.abs(R.top-s.top)-Math.abs(S.top-s.top)}),a[0].dataset.id}addScrollListenersWithThrottle(){document.querySelectorAll(".tree-container").forEach(n=>{n.addEventListener("scroll",this.throttle(()=>this.drawConnections(),10))})}throttle(t,n){let i=0;return()=>{const r=Date.now();r-i>=n&&(i=r,t())}}getNodeVisibilityPosition(t){const n=document.querySelector(`[data-id="${t}"]`)?.querySelector(".tree-label");if(!n)return"unknown";const i=n.closest(".tree-container");if(!i)return"unknown";const r=n.getBoundingClientRect(),e=i.getBoundingClientRect();let s=null;return r.top===0&&(s=this.getParentNode(t)),r.top===0&&s?s.top<e.top?"top":s.bottom>e.bottom?"bottom":"visible":r.top<e.top?"top":r.bottom>e.bottom?"bottom":"visible"}findFirstVisibleNode(){const t=document.querySelectorAll(".tree-node");for(const n of Array.from(t)){const i=n.dataset.id;if(this.isNodeVisible(i))return n}return null}drawConnections(){const t=document.getElementById("connection-layer");if(t&&(t.innerHTML="",t.getBoundingClientRect(),this.connections.forEach(n=>{const i=document.querySelector(`[data-id="${n.source}"] .tree-label`),r=document.querySelector(`[data-id="${n.target}"] .tree-label`);if(i&&r){const e=t.getBoundingClientRect(),s=i.closest(".tree-container");if(!s)return;const a=r.closest(".tree-container");if(!a)return;const o=i.getBoundingClientRect(),E=r.getBoundingClientRect(),l=s.getBoundingClientRect(),p=a.getBoundingClientRect(),R=n.source.startsWith("left-")&&n.target.startsWith("right-"),S=n.source.startsWith("right-")&&n.target.startsWith("left-"),A=this.getNodeVisibilityPosition(n.source),v=this.getNodeVisibilityPosition(n.target);let m,h,b,u;if(this.isNodeVisible(n.source)){const y=s.getBoundingClientRect();m=s.id==="leftTree"?y.right+5-e.left:y.left-5-e.left,h=o.top+o.height/2-e.top}else{const y=document.querySelector(`[data-id="${n.source}"]`);let c=null,g=y.parentElement;for(;g&&g.classList.contains("tree-children");){if(!g.classList.contains("active")){const N=g.parentElement.dataset.id;if(this.isNodeVisible(N)){c=N;break}}g=g.parentElement?.parentElement||null}if(c){const N=document.querySelector(`[data-id="${c}"] .tree-label`).getBoundingClientRect();m=s.id==="leftTree"?l.right+5-e.left:l.left-5-e.left,h=N.top+N.height/2-e.top}else if(m=s.id==="leftTree"?l.right+5-e.left:l.left-5-e.left,A==="top")h=l.top-e.top;else if(A==="bottom")h=l.bottom-e.top;else{const d=this.findNearestVisibleAncestor(n.source);if(d){const N=document.querySelector(`[data-id="${d}"] .tree-label`).getBoundingClientRect();h=N.top+N.height/2-e.top}else h=l.top+l.height/2-e.top}}m-=e.left,h-=e.top;let k=null;if(!this.isNodeVisible(n.source)){let c=document.querySelector(`[data-id="${n.source}"]`).parentElement;for(;c&&c.classList.contains("tree-children");){if(!c.classList.contains("active")){const d=c.parentElement.dataset.id;if(this.isNodeVisible(d)){k=d;break}}c=c.parentElement?.parentElement||null}}A==="top"&&!k&&(h=s.getBoundingClientRect().top-e.top);let T=null;if(this.isNodeVisible(n.target))b=a.id==="leftTree"?p.right+5-e.left:p.left-5-e.left,u=E.top+E.height/2-e.top;else{let c=document.querySelector(`[data-id="${n.target}"]`).parentElement;for(;c&&c.classList.contains("tree-children");){if(!c.classList.contains("active")){const d=c.parentElement.dataset.id;if(this.isNodeVisible(d)){T=d;break}}c=c.parentElement?.parentElement||null}if(T){const d=document.querySelector(`[data-id="${T}"] .tree-label`).getBoundingClientRect();b=a.id==="leftTree"?p.right+5-e.left:p.left-5-e.left,u=d.top+d.height/2-e.top}else if(b=a.id==="leftTree"?p.right+5-e.left:p.left-5-e.left,v==="top")u=p.top-e.top-10;else if(v==="bottom")u=p.bottom-10-e.top;else{const g=this.findNearestVisibleAncestor(n.target);if(g){const d=document.querySelector(`[data-id="${g}"] .tree-label`).getBoundingClientRect();u=d.top+d.height/2-e.top}else u=p.top+p.height/2-e.top}}b-=e.left,u-=e.top,v==="top"&&!T?u=a.getBoundingClientRect().top-e.top:v==="bottom"&&!T&&(u=a.getBoundingClientRect().bottom-e.top);const f=document.createElementNS("http://www.w3.org/2000/svg","path");let L;const C=this.bezier||100;R?(L=`M ${m} ${h} C ${m+C} ${h}, ${b-C} ${u}, ${b} ${u}`,f.setAttribute("marker-end","url(#arrowhead-end)")):S?(L=`M ${m} ${h} C ${m-C} ${h}, ${b+C} ${u}, ${b} ${u}`,f.setAttribute("marker-end","url(#arrowhead-start)")):L=`M ${m} ${h} C ${m+C} ${h}, ${b-C} ${u}, ${b} ${u}`,f.setAttribute("d",L),R?f.setAttribute("stroke","#0090F0"):S?f.setAttribute("stroke","#FE732F"):f.setAttribute("stroke","#666");const B=this.isNodeVisible(n.source),V=this.isNodeVisible(n.target),q=A==="top",x=v==="top";f.setAttribute("stroke-width","1.5"),f.setAttribute("fill","none"),q||x||!B||!V?f.setAttribute("stroke-dasharray","5,5"):f.removeAttribute("stroke-dasharray"),t.appendChild(f)}}),this.connections.length>0&&!document.getElementById("arrowhead-end"))){const n=document.createElementNS("http://www.w3.org/2000/svg","defs"),i=document.createElementNS("http://www.w3.org/2000/svg","marker");i.setAttribute("id","arrowhead-end"),i.setAttribute("markerWidth","10"),i.setAttribute("markerHeight","7"),i.setAttribute("refX","9"),i.setAttribute("refY","3.5"),i.setAttribute("orient","auto");const r=document.createElementNS("http://www.w3.org/2000/svg","polygon");r.setAttribute("points","0 0, 10 3.5, 0 7"),r.setAttribute("fill","#4096ff"),i.appendChild(r);const e=document.createElementNS("http://www.w3.org/2000/svg","marker");e.setAttribute("id","arrowhead-start"),e.setAttribute("markerWidth","10"),e.setAttribute("markerHeight","7"),e.setAttribute("refX","9"),e.setAttribute("refY","3.5"),e.setAttribute("orient","auto");const s=document.createElementNS("http://www.w3.org/2000/svg","polygon");s.setAttribute("points","0 0, 10 3.5, 0 7"),s.setAttribute("fill","#ff7a45"),e.appendChild(s),n.appendChild(i),n.appendChild(e),t.appendChild(n)}}initializeTrees(){const t=document.getElementById("leftTree"),n=document.getElementById("rightTree");!t||!n||(this.leftTreeData.forEach(i=>{this.renderTreeNode(i,t)}),this.rightTreeData.forEach(i=>{this.renderTreeNode(i,n)}),this.addScrollListenersWithThrottle(),this.connections.push(...this.linkList),this.drawConnections())}redraw(){this.drawConnections()}updateData(t,n,i){this.leftTreeData=t,this.rightTreeData=n,this.linkList=i,this.connections=[...i],this.initializeTrees()}}return w}));
